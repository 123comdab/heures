<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Heures</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        #totalsTable th { @apply bg-blue-100; }
        .error { color: red; }
        /* Pour le nouvel onglet */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-6">

    <!-- Formulaire de mot de passe -->
    <div id="passwordForm" class="bg-white p-6 rounded-lg shadow max-w-sm mx-auto">
        <h2 class="text-xl font-semibold mb-4">Connexion</h2>
        <label for="passwordInput" class="block text-sm font-medium text-gray-700">Mot de passe:</label>
        <input type="password" id="passwordInput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        <button id="submitPasswordBtn" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Déverrouiller
        </button>
        <p id="passwordError" class="error mt-2 hidden"></p>
    </div>

    <!-- Contenu de l'application -->
    <div id="appContent" class="hidden">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestion des Heures</h1>

        <!-- Onglets -->
        <div class="mb-4">
            <button id="tabHours" class="tab-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2" onclick="openTab('tabHoursContent')">Saisie des Heures</button>
            <button id="tabEmployees" class="tab-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" onclick="openTab('tabEmployeesContent')">Gestion des Employés</button>
              <button id="tabImport" class="tab-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" onclick="openTab('tabImportContent')">Import/Export</button>
        </div>

        <!-- Contenu des onglets -->
        <div id="tabHoursContent" class="tab-content active">
            <!-- (Le contenu existant pour la saisie des heures) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Formulaire d'ajout d'employé -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Ajouter un Employé</h2>
                    <label for="employeeName" class="block text-sm font-medium text-gray-700">Nom de l'employé:</label>
                    <input type="text" id="employeeName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <button id="addEmployeeBtn" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Ajouter Employé
                    </button>
                    <p id="employeeError" class="error mt-2 hidden"></p>
                </div>

                <!-- Formulaire de saisie des heures -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Saisir les Heures</h2>
                    <label for="employeeSelect" class="block text-sm font-medium text-gray-700">Employé:</label>
                    <select id="employeeSelect" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Sélectionnez un employé</option>
                    </select>

                    <label for="date" class="block text-sm font-medium text-gray-700 mt-4">Date:</label>
                    <input type="date" id="date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="morningArrival" class="block text-sm font-medium text-gray-700">Arrivée (Matin):</label>
                            <input type="time" id="morningArrival" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="morningDeparture" class="block text-sm font-medium text-gray-700">Départ (Matin):</label>
                            <input type="time" id="morningDeparture" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="afternoonArrival" class="block text-sm font-medium text-gray-700">Arrivée (Après-midi):</label>
                            <input type="time" id="afternoonArrival" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="afternoonDeparture" class="block text-sm font-medium text-gray-700">Départ (Après-midi):</label>
                            <input type="time" id="afternoonDeparture" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>

                    <button id="addHoursBtn" class="mt-6 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Ajouter les Heures
                    </button>
                    <p id="hoursError" class="error mt-2 hidden"></p>
                </div>
            </div>

            <!-- Tableaux -->
            <div class="mt-8 overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4">Heures Travaillées</h2>
                <table id="hoursTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employé</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrivée (M)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Départ (M)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrivée (AM)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Départ (AM)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Heures</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>

            </div>

            <div class="mt-8 overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4">Totaux par Mois</h2>
                <table id="totalsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employé</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mois</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Heures</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Onglet pour la gestion des employés -->
        <div id="tabEmployeesContent" class="tab-content">
             <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Liste des Employés</h2>
            <p id="deleteEmployeeMessage" class=" mt-2 "></p>
            <ul id="employeeList">
                <!-- La liste des employés sera générée ici -->
            </ul>
            </div>
        </div>
        <!-- Onglet Import/Export -->
        <div id="tabImportContent" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Importer / Exporter les données</h2>
                <p id="importMessage" class="mt-2"></p>

                <button id="importCSVBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Importer CSV
                </button>
                <input type="file" id="fileInput" accept=".csv" class="hidden">

                <button id="exportCSVBtn" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Exporter en CSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Éléments du DOM ---
        const employeeNameInput = document.getElementById('employeeName');
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const employeeSelect = document.getElementById('employeeSelect');
        const dateInput = document.getElementById('date');
        const morningArrivalInput = document.getElementById('morningArrival');
        const morningDepartureInput = document.getElementById('morningDeparture');
        const afternoonArrivalInput = document.getElementById('afternoonArrival');
        const afternoonDepartureInput = document.getElementById('afternoonDeparture');
        const addHoursBtn = document.getElementById('addHoursBtn');
        const hoursTableBody = document.getElementById('hoursTable').getElementsByTagName('tbody')[0];
        const totalsTableBody = document.getElementById('totalsTable').getElementsByTagName('tbody')[0];
        const employeeError = document.getElementById('employeeError');
        const hoursError = document.getElementById('hoursError');
        const passwordForm = document.getElementById('passwordForm');
        const passwordInput = document.getElementById('passwordInput');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const passwordError = document.getElementById('passwordError');
        const appContent = document.getElementById('appContent');
        const employeeList = document.getElementById('employeeList'); // La liste des employés
        const deleteEmployeeMessage = document.getElementById('deleteEmployeeMessage'); //Les messages de confirmation
        const importCSVBtn = document.getElementById('importCSVBtn'); //Bouton d'importation
        const fileInput = document.getElementById('fileInput'); //Champs de fichier (caché)
        const importMessage = document.getElementById('importMessage');  // Messages d'import/export
        const exportCSVBtn = document.getElementById("exportCSVBtn");

        // --- MOT DE PASSE EN CLAIR (À NE PAS FAIRE EN PRODUCTION) ---
        const CORRECT_PASSWORD = '0194';

        // --- Fonctions utilitaires ---

        // Affiche une erreur
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.add('error');
        }

        // Masque une erreur
        function hideError(element) {
            element.textContent = '';
            element.classList.add('hidden');
            element.classList.remove('error');
        }

        // Gestionnaire d'erreurs localStorage (générique)
        function handleLocalStorageError(error) {
            console.error("Erreur localStorage:", error);
            alert("Une erreur s'est produite lors de l'accès au stockage local.  Veuillez vérifier que localStorage est activé et non plein.");
        }

        // --- Fonctions localStorage (avec gestion d'erreurs) ---
        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                handleLocalStorageError(error);
            }
        }

        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                handleLocalStorageError(error);
                return null;
            }
        }

        // --- Vérification du mot de passe ---
        function checkPassword() {
            const password = passwordInput.value;
            if (password === CORRECT_PASSWORD) {
                passwordForm.style.display = 'none';
                appContent.classList.remove('hidden');
                initializeAppData();
            } else {
                showError(passwordError, "Mot de passe incorrect.");
            }
        }

        // --- Initialisation de l'application (après la "connexion") ---
        function initializeAppData() {
            updateEmployeeSelect();
            loadCachedEntry();
            renderHoursTable();
            renderTotalsTable();
            renderEmployeeList();
            openTab('tabHoursContent'); //Ouvre l'onglet par défaut
        }

        // --- Gestion des employés ---
        function addEmployee() {
            const name = employeeNameInput.value.trim();
            if (!name) {
                showError(employeeError, "Veuillez entrer un nom d'employé.");
                return;
            }

            const employees = loadData('employees') || [];
            if (employees.some(emp => emp.name === name)) {
                showError(employeeError, "Cet employé existe déjà.");
                return;
            }

            hideError(employeeError);
            employees.push({ id: Date.now(), name: name });
            saveData('employees', employees);
            updateEmployeeSelect();
            renderEmployeeList();
            employeeNameInput.value = "";
        }

        function updateEmployeeSelect() {
            const employees = loadData('employees') || [];
            employeeSelect.innerHTML = '<option value="">Sélectionnez un employé</option>';

            if (employees && employees.length > 0) {
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    employeeSelect.appendChild(option);
                });
            }
        }

        function deleteEmployee(employeeId) {
            let employees = loadData('employees') || [];
            let hoursData = loadData('hoursData') || [];

            employees = employees.filter(emp => emp.id !== employeeId);
            hoursData = hoursData.filter(entry => entry.employeeId !== employeeId);

            if (parseInt(employeeSelect.value, 10) === employeeId) {
                employeeSelect.value = "";
            }

            saveData('employees', employees);
            saveData('hoursData', hoursData);

            updateEmployeeSelect();
            renderHoursTable();
            renderTotalsTable();
            renderEmployeeList();

            deleteEmployeeMessage.textContent = "Employé supprimé avec succès, ainsi que toutes ses heures associées.";
            deleteEmployeeMessage.classList.remove('error');
            setTimeout(() => {
                deleteEmployeeMessage.textContent = "";
            }, 3000);
        }

        // --- Gestion des heures ---
        function addHours() {
            const employeeId = employeeSelect.value;
            const date = dateInput.value;
            const morningArrival = morningArrivalInput.value;
            const morningDeparture = morningDepartureInput.value;
            const afternoonArrival = afternoonArrivalInput.value;
            const afternoonDeparture = afternoonDepartureInput.value;

            if (employeeId === "" || date === "") {
                showError(hoursError, "Veuillez sélectionner un employé et une date.");
                return;
            }

            if (!morningArrival && !morningDeparture && !afternoonArrival && !afternoonDeparture) {
                showError(hoursError, "Veuillez saisir au moins une plage horaire.");
                return;
            }

            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                showError(hoursError, "Format de date invalide (AAAA-MM-JJ).");
                return;
            }

            function isValidTime(time) {
                return /^\d{2}:\d{2}$/.test(time);
            }

            function isDepartureAfterArrival(arrival, departure) {
                if (!isValidTime(arrival) || !isValidTime(departure)) {
                    return false;
                }
                return calculateTimeDifference(arrival, departure) > 0;
            }

            if (morningArrival && morningDeparture && !isDepartureAfterArrival(morningArrival, morningDeparture)) {
                showError(hoursError, "L'heure de départ du matin doit être après l'heure d'arrivée.");
                return;
            }
            if (afternoonArrival && afternoonDeparture && !isDepartureAfterArrival(afternoonArrival, afternoonDeparture)) {
                showError(hoursError, "L'heure de départ de l'après-midi doit être après l'heure d'arrivée.");
                return;
            }
            if (morningDeparture && afternoonArrival && calculateTimeDifference(morningDeparture, afternoonArrival) <=0){
                showError(hoursError, "Il y a un chevauchement entre la plage horaire du matin et celle de l'après-midi.");
                return;
            }

            hideError(hoursError);

            const employees = loadData('employees') || [];
            const employee = employees.find(emp => emp.id === parseInt(employeeId, 10));

            if (!employee) {
                showError(hoursError, "Employé introuvable.  Veuillez recharger la page.");
                return;
            }
            const employeeName = employee.name;

            let totalHours = 0;
            if (morningArrival && morningDeparture) {
                totalHours += calculateTimeDifference(morningArrival, morningDeparture);
            }
            if (afternoonArrival && afternoonDeparture) {
                totalHours += calculateTimeDifference(afternoonArrival, afternoonDeparture);
            }

            const newEntry = {
                employeeId: parseInt(employeeId, 10),
                employee: employeeName,
                date,
                morningArrival: morningArrival || '',
                morningDeparture: morningDeparture || '',
                afternoonArrival: afternoonArrival || '',
                afternoonDeparture: afternoonDeparture || '',
                totalHours
            };

            const hoursData = loadData('hoursData') || [];
            hoursData.push(newEntry);
            saveData('hoursData', hoursData);
            renderHoursTable();
            renderTotalsTable();
            cacheLastEntry(newEntry);
            clearHoursInputs();
        }

        function calculateTimeDifference(startTime, endTime) {
            const start = new Date(`1970-01-01T${startTime}:00`);
            const end = new Date(`1970-01-01T${endTime}:00`);
            return (end - start) / (1000 * 60 * 60);
        }

        function renderHoursTable() {
            const hoursData = loadData('hoursData') || [];
            hoursTableBody.innerHTML = '';
            hoursData.forEach((data, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${data.employee}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.morningArrival}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.morningDeparture}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.afternoonArrival}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.afternoonDeparture}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.totalHours.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="deleteBtn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs" data-index="${index}">Supprimer</button>
                    </td>
                `;
                hoursTableBody.appendChild(row);
            });
            attachDeleteHandlers();
        }

        function renderTotalsTable() {
            const hoursData = loadData('hoursData') || [];
            totalsTableBody.innerHTML = '';
            const totals = calculateMonthlyTotals(hoursData);
            for (const key in totals) {
                const parts = key.split('|');
                const employeeName = parts[0];
                const month = parts[1];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${employeeName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${month}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${totals[key].toFixed(2)}</td>
                `;
                totalsTableBody.appendChild(row);
            }
        }

        function calculateMonthlyTotals(hoursData) {
            const totals = {};
            hoursData.forEach(data => {
                const month = data.date.substring(0, 7);
                const key = `${data.employee}|${month}`;
                totals[key] = (totals[key] || 0) + data.totalHours;
            });
            return totals;
        }

        function clearHoursInputs() {
            dateInput.value = "";
            morningArrivalInput.value = "";
            morningDepartureInput.value = "";
            afternoonArrivalInput.value = "";
            afternoonDepartureInput.value = "";
        }

        function deleteHoursEntry(index) {
            const hoursData = loadData('hoursData') || [];
            hoursData.splice(index, 1);
            saveData('hoursData', hoursData);
            renderHoursTable();
            renderTotalsTable();
        }

        function attachDeleteHandlers() {
            hoursTableBody.querySelectorAll('.deleteBtn').forEach(button => {
                button.addEventListener('click', () => {
                    deleteHoursEntry(parseInt(button.dataset.index, 10));
                });
            });
        }

        function cacheLastEntry(entry) {
            localStorage.setItem('lastHoursEntry', JSON.stringify(entry));
        }

        function loadCachedEntry() {
            const cachedEntry = loadData('lastHoursEntry');
            if (cachedEntry) {
                const employees = loadData('employees') || [];
                if (employees.some(emp => emp.id === parseInt(cachedEntry.employeeId, 10))) {
                   if (!employeeSelect.value) {
                        employeeSelect.value = cachedEntry.employeeId;
                    }
                }
                dateInput.value = cachedEntry.date;
                morningArrivalInput.value = cachedEntry.morningArrival;
                morningDepartureInput.value = cachedEntry.morningDeparture;
                afternoonArrivalInput.value = cachedEntry.afternoonArrival;
                afternoonDepartureInput.value = cachedEntry.afternoonDeparture;
            }
        }

        // --- Gestion des onglets ---
        function openTab(tabId) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            const tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("bg-blue-500", "hover:bg-blue-700", "text-white");
                tabButtons[i].classList.add("bg-gray-300", "hover:bg-gray-400", "text-gray-800");
            }

            document.getElementById(tabId).classList.add("active");
            const buttonId = tabId.replace("Content", "");
            document.getElementById(buttonId).classList.add("bg-blue-500", "hover:bg-blue-700", "text-white");
            document.getElementById(buttonId).classList.remove("bg-gray-300", "hover:bg-gray-400", "text-gray-800");
        }

        // --- Affichage de la liste des employés (pour la suppression) ---
        function renderEmployeeList() {
            const employees = loadData('employees') || [];
            employeeList.innerHTML = '';

            if (employees.length === 0) {
                employeeList.innerHTML = '<li>Aucun employé enregistré.</li>';
                return;
            }

            employees.forEach(employee => {
                const listItem = document.createElement('li');
                listItem.className = 'mb-2';
                listItem.textContent = employee.name;

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Supprimer';
                deleteButton.className = 'bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs ml-2';
                deleteButton.addEventListener('click', () => deleteEmployee(employee.id));

                listItem.appendChild(deleteButton);
                employeeList.appendChild(listItem);
            });
        }

        // --- Import/Export CSV ---
        function exportToCSV() {
            const hoursData = loadData('hoursData') || [];
            const employees = loadData('employees') || [];

            let csvContent = "data:text/csv;charset=utf-8,";
            let csvData = [];

            csvData.push([
                "Employé", "Date", "Arrivée (Matin)", "Départ (Matin)",
                "Arrivée (Après-midi)", "Départ (Après-midi)", "Total Heures"
            ]);

            hoursData.forEach(data => {
                const employee = employees.find(emp => emp.id === data.employeeId);
                const employeeName = employee ? employee.name : "Employé Supprimé";

                const row = [
                    employeeName,
                    data.date,
                    data.morningArrival,
                    data.morningDeparture,
                    data.afternoonArrival,
                    data.afternoonDeparture,
                    data.totalHours.toFixed(2)
                ];
                csvData.push(row);
            });

            csvData.forEach(rowArray => {
                let row = rowArray.join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "heures_travaillees.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importFromCSV() {
            const file = fileInput.files[0];
            if (!file) {
                importMessage.textContent = "Aucun fichier sélectionné.";
                importMessage.classList.add('error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                parseCSV(content);
            };
            reader.onerror = function() {
                importMessage.textContent = "Erreur lors de la lecture du fichier.";
                 importMessage.classList.add('error');
            };
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.split(/\r\n|\n/);
            const headers = lines[0].split(',');
            const newHoursData = [];
            const employees = loadData('employees') || [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const data = line.split(',');
                if (data.length !== headers.length) {
                  importMessage.textContent = `Erreur à la ligne ${i + 1}: Nombre de colonnes incorrect.`;
                  importMessage.classList.add('error');
                  continue;
                }

                let employeeName = data[0].trim();
                let employeeId = null;
                let employee = employees.find(emp => emp.name === employeeName);

                if (employee) {
                    employeeId = employee.id;
                } else {
                    employeeId = Date.now();
                    employees.push({ id: employeeId, name: employeeName });
                    saveData('employees', employees);
                }

                const newEntry = {
                    employeeId: employeeId,
                    employee: employeeName,
                    date: data[1].trim(),
                    morningArrival: data[2].trim(),
                    morningDeparture: data[3].trim(),
                    afternoonArrival: data[4].trim(),
                    afternoonDeparture: data[5].trim(),
                    totalHours: parseFloat(data[6].trim()) // Convertit en nombre
                };

                newHoursData.push(newEntry);
            }

            // Fusion des données importées avec les données existantes
            const existingHoursData = loadData('hoursData') || [];
            const combinedHoursData = existingHoursData.concat(newHoursData); // Combine les tableaux
            saveData('hoursData', combinedHoursData);

            renderHoursTable();
            renderTotalsTable();
            updateEmployeeSelect();
            importMessage.textContent = "Données importées avec succès !";
            importMessage.classList.remove('error');
            setTimeout(()=>{
                importMessage.textContent = "";
            },3000); // Efface le message après 3 secondes
        }

        // --- Initialisation ---
        appContent.classList.add('hidden');
        passwordForm.style.display = 'block';

        // Gestionnaires d'événements
        submitPasswordBtn.addEventListener('click', (event) => {
            event.preventDefault();
            checkPassword();
        });
        addEmployeeBtn.addEventListener('click', addEmployee);
        addHoursBtn.addEventListener('click', addHours);
        exportCSVBtn.addEventListener('click', exportToCSV);
        employeeSelect.addEventListener('change', loadCachedEntry);
        importCSVBtn.addEventListener('click', () => {
             fileInput.click();
         });
        fileInput.addEventListener('change', importFromCSV);

    </script>
</body>
</html>